<!doctype html>
<html>
	<head>
		<title>Wikimirs</title>
		<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
		<link href="css/bootstrap-notify.css" rel="stylesheet">
	</head>
	<body>
	<div style="text-align: center;">
		<div>
			<input type="text" id="query" name="query"></input>
			<button id="search">Search</button>
		</div>
		<div id="box" style="width:300px;overflow: auto;text-align: center;margin-left:auto;margin-right:auto;">
			<div id="query_formula"></div>
		</div>
	</div>	
	<div id="search_results" class="container main-body">
		<div id="query_detail"></div>
		<div id="search_summary">
		</div>
		<div id="search_result_items" class="row">
			<!-- <div id="search_result_item"></div> -->
		</div>
	</div>
	<div class='notifications top-center'></div>
	</body>
	<script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/bootstrap-notify.js"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<script type="text/javascript">
	$(function() {
		$("#search").click(function() {
			var query = $("#query").val();
			renderQuery(query);
			search(query, 1);
		});
		//$("#search_results").hide();
	});
	
	function renderQuery(query) {
		renderFormula("query_formula", query);
	}
	
	function renderFormula(id, formula) {
		$("#" + id).text("$$ " + formula + " $$");
		MathJax.Hub.Queue(["Typeset",MathJax.Hub, id]);
	}
	
	function search(query, page) {
		var url = "search?q=" + encodeURIComponent(query) + "&page=" + page;
		$.get(url, function(data) {
			console.log(data)
			if (data.status == "OK") {
				data.query = query
				renderSearchResult(data);
			}
			else {
				error("Request Failed: " + data.status);
			}
		}).fail(function( jqxhr, textStatus, error ) {
		  var err = textStatus + ', ' + error;
		  error("Request Failed: " + err);
		});
	}
	
	function error(error) {
		$('.top-center').notify({
				type: "error",
				message: { text: error }
			}).show();
		console.log(error);
	}
	
	function renderSearchResult(data) {
		if(data.results.length == 0) {
			renderEmptyResult(data.query);
		}
		else {
			var summary = "About" + data.total + "results ("+ data.time +" seconds)";
			$("#search_summary").text(summary);
			var search_results_div = $("#search_result_items");
			$.each(data.results, function() {
				search_results_div.append(renderOneResult(this));
			});
			$.each(data.results, function() {
				renderFormula("formula" + this.doc.formula_id, this.doc.formula);
			});
		}
		$("#query_detail").html(data.query_detail)
		$("#search_results").show();
	}
	
	function renderOneResult(result) {
		var title = result.doc.doc_title;
		var score = result.score;
		var formula = result.doc.formula;
		var explain = result.explain;
		var wrapper = $("<div class='search_result_item'>");
		wrapper.append($("<div>").text(title));
		wrapper.append($("<div>").text(score));
		wrapper.append($("<div id='formula" + result.doc.formula_id + "'>"));
		wrapper.append($("<div>").html(explain));
		return wrapper;
	}
	
	function renderEmptyResult(query) {
		$("#search_summary").html("Your search - " + em(query) + " - did not match any documents.")
	}
	
	function em(text) {
		return $("<em>").text(text).wrap('<div>').parent().html();
	}
	</script>
</html>